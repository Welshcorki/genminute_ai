
{% extends "layout.html" %}

{% block title %}모든 노트{% endblock %}

{% block content %}
<main class="content-panel">
    <div class="viewer-container"> {# viewer-container 스타일 재사용 #}
        <header class="viewer-header">
            <h1>모든 노트</h1>
        </header>

        <div class="notes-list">
            {% if meetings %}
                {% for meeting in meetings %}
                    <div class="note-item-wrapper">
                        <a href="{{ url_for('view_meeting', meeting_id=meeting.meeting_id) }}" class="note-item">
                            <div class="note-item-title">{{ meeting.title }}</div>
                            <div class="note-item-date">{{ meeting.date }}</div>
                        </a>
                        <button class="delete-note-btn"
                                data-meeting-id="{{ meeting.meeting_id }}"
                                data-title="{{ meeting.title }}"
                                data-audio-file="{{ meeting.audio_file }}"
                                onclick="confirmDelete(event, this)"
                                title="노트 삭제">✕</button>
                    </div>
                {% endfor %}
            {% else %}
                <p>저장된 노트가 없습니다.</p>
            {% endif %}
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>노트 삭제</h2>
            <p id="delete-message">정말로 이 노트를 삭제하시겠습니까?</p>
            <p style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;">
                ⚠️ 오디오 파일, 스크립트, 청킹된 텍스트, 문단 요약, 회의록을 포함한 모든 데이터가 삭제됩니다.
            </p>
            <div class="modal-buttons">
                <button id="confirm-delete-btn" class="btn-danger">예</button>
                <button id="cancel-delete-btn" class="btn-secondary">아니오</button>
            </div>
        </div>
    </div>
</main>

<style>
.note-item-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.note-item {
    flex: 1;
    text-decoration: none;
    color: inherit;
}

.delete-note-btn {
    position: absolute;
    right: 1rem;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 1.2rem;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
}

.delete-note-btn:hover {
    background: #cc0000;
    transform: scale(1.1);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-content h2 {
    margin-top: 0;
    color: #333;
}

.modal-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    justify-content: flex-end;
}

.btn-danger {
    background: #ff4444;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
}

.btn-danger:hover {
    background: #cc0000;
}

.btn-secondary {
    background: #666;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
}

.btn-secondary:hover {
    background: #444;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentDeleteData = null;

function confirmDelete(event, button) {
    event.preventDefault();
    event.stopPropagation();

    const meetingId = button.dataset.meetingId;
    const title = button.dataset.title;
    const audioFile = button.dataset.audioFile;

    currentDeleteData = { meetingId, title, audioFile };

    const modal = document.getElementById('delete-modal');
    const message = document.getElementById('delete-message');
    message.textContent = `"${title}" 노트를 정말로 삭제하시겠습니까?`;
    modal.style.display = 'flex';
}

document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
    if (!currentDeleteData) return;

    const { meetingId, audioFile } = currentDeleteData;

    try {
        // 삭제 요청
        const response = await fetch(`/api/delete_meeting/${meetingId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                audio_file: audioFile
            })
        });

        const data = await response.json();

        if (data.success) {
            alert('노트가 성공적으로 삭제되었습니다.');
            // 페이지 새로고침
            window.location.reload();
        } else {
            alert(`삭제 실패: ${data.error}`);
        }
    } catch (error) {
        console.error('삭제 요청 중 오류:', error);
        alert('삭제 요청 중 오류가 발생했습니다.');
    } finally {
        closeModal();
    }
});

document.getElementById('cancel-delete-btn').addEventListener('click', closeModal);

function closeModal() {
    const modal = document.getElementById('delete-modal');
    modal.style.display = 'none';
    currentDeleteData = null;
}

// 모달 배경 클릭 시 닫기
document.getElementById('delete-modal').addEventListener('click', (e) => {
    if (e.target.id === 'delete-modal') {
        closeModal();
    }
});
</script>
{% endblock %}
