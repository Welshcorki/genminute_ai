# 고아 데이터 버그 수정 완료 보고서

**작성일**: 2025-01-06
**문제**: uploads 폴더에 파일 3개, 노트는 1개만 보이는 현상

---

## 🔍 문제 분석

### 발견된 상황
```
uploads 폴더: 3개 파일
  ✅ 000009.wav
  ❌ 4-_251105_155055.m4a (5.54 MB)
  ❌ meetingV3.mp4 (107.72 MB)

SQLite meeting_dialogues: 1개
  ✅ 6b1bdfeb-3dfb-49e4-b33b-81f49c3340cb → 000009.wav

Vector DB: 2개 (고아 데이터!)
  ❌ 1f0aab5c-d5f8-4524-a200-b54be1c0074c → meetingV3.mp4 (3차 회의)
  ❌ f6f1f052-40eb-4dc1-aa68-97df60dcda26 → 4-_251105_155055.m4a (4차회의)
```

### 근본 원인

**삭제 로직의 치명적 버그** (vector_db_manager.py:614-617):

```python
# 기존 코드 (버그)
audio_file = self.db_manager.get_audio_file_by_meeting_id(meeting_id)

if not audio_file:
    raise ValueError(f"meeting_id '{meeting_id}'에 해당하는 회의를 찾을 수 없습니다.")
```

**문제점**:
1. SQLite meeting_dialogues에서 audio_file 조회
2. 만약 이미 삭제되었으면 → audio_file = None
3. **ValueError 발생 → 삭제 프로세스 중단!**
4. **Vector DB와 파일이 삭제되지 않음**

### 시나리오 재구성

1. 사용자가 "3차 회의", "4차 회의" 삭제 시도
2. SQLite meeting_dialogues 삭제 성공 ✅
3. audio_file 조회 시도 → None (이미 삭제됨)
4. ValueError 발생 ❌
5. **Vector DB 삭제 안 됨, 파일도 삭제 안 됨**
6. 고아 데이터 발생!

---

## ✅ 해결 방법

### 1. 고아 데이터 정리 (임시 해결)

**파일**: `cleanup_orphan_data.py` 생성

**실행 결과**:
```
📊 Vector DB에서 2개 meeting_id 삭제 중...
  ✅ 1f0aab5c-d5f8-4524-a200-b54be1c0074c: 92개 메타데이터 삭제
  ✅ f6f1f052-40eb-4dc1-aa68-97df60dcda26: 116개 메타데이터 삭제
  ✅ Vector DB 정리 완료

📂 uploads 폴더에서 2개 파일 삭제 중...
  ✅ 4-_251105_155055.m4a 삭제 완료
  ✅ meetingV3.mp4 삭제 완료
  ✅ 파일 정리 완료

🎉 고아 데이터 정리 완료!
```

---

### 2. 삭제 로직 개선 (근본 해결)

**파일**: `utils/vector_db_manager.py`

#### 변경 1: `_get_audio_file_from_vector_db()` 함수 추가 (583-615줄)

```python
def _get_audio_file_from_vector_db(self, meeting_id):
    """
    Vector DB에서 meeting_id로 audio_file을 조회합니다.
    SQLite에서 조회 실패 시 폴백으로 사용됩니다.
    """
    try:
        import sqlite3
        conn = sqlite3.connect(os.path.join(os.path.dirname(__file__), '..',
                                             'database', 'vector_db', 'chroma.sqlite3'))
        cursor = conn.cursor()

        cursor.execute('''
            SELECT string_value
            FROM embedding_metadata
            WHERE key = "audio_file" AND id IN (
                SELECT DISTINCT id FROM embedding_metadata
                WHERE key = "meeting_id" AND string_value = ?
            )
            LIMIT 1
        ''', (meeting_id,))

        result = cursor.fetchone()
        conn.close()

        return result[0] if result else None
    except Exception as e:
        print(f"⚠️ Vector DB에서 audio_file 조회 실패: {e}")
        return None
```

**역할**: SQLite에서 조회 실패 시 Vector DB에서 audio_file을 찾음

---

#### 변경 2: audio_file 조회 로직 개선 (647-661줄)

```python
# 개선된 코드
audio_file = self.db_manager.get_audio_file_by_meeting_id(meeting_id)

if not audio_file:
    print("⚠️ SQLite에서 audio_file을 찾을 수 없습니다. Vector DB에서 조회 시도...")
    audio_file = self._get_audio_file_from_vector_db(meeting_id)

if not audio_file:
    print("⚠️ audio_file을 찾을 수 없습니다. 파일 삭제를 건너뜁니다.")
    print("   (SQLite와 Vector DB 삭제는 계속 진행됩니다)")
    audio_file = None  # 파일 삭제 단계에서 처리
else:
    print(f"📄 미디어 파일명: {audio_file}")
```

**개선점**:
1. SQLite 조회 실패 → Vector DB에서 조회
2. 둘 다 실패 → 경고만 하고 계속 진행
3. **ValueError 발생 안 함!**

---

#### 변경 3: 파일 삭제 단계 개선 (756-789줄)

```python
# 개선된 코드
audio_deleted = False

if audio_file:
    audio_path = os.path.join(self.upload_folder, audio_file)

    if os.path.exists(audio_path):
        os.remove(audio_path)
        print(f"✅ 미디어 파일 삭제 검증 성공")
        audio_deleted = True
    else:
        print(f"ℹ️ 미디어 파일이 존재하지 않습니다.")
else:
    print(f"[건너뜀] audio_file 정보 없음")
    print(f"ℹ️ audio_file을 찾을 수 없어 파일 삭제를 건너뜁니다.")
```

**개선점**:
- audio_file이 None인 경우에도 정상 처리
- 파일 삭제 실패해도 SQLite/Vector DB 삭제는 계속 진행

---

## 📊 수정 요약

| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| audio_file 조회 | SQLite만 조회 | SQLite → Vector DB (폴백) |
| 조회 실패 시 | ValueError 발생 | 경고만 하고 계속 진행 |
| 파일 삭제 | 필수 | 선택적 (없으면 건너뜀) |
| 고아 데이터 발생 | ❌ 발생 가능 | ✅ 발생 방지 |

---

## ✅ 검증 완료

### 문법 검증
```bash
✅ vector_db_manager.py 문법 OK
```

### 수정된 파일
1. `utils/vector_db_manager.py` (3개 함수 수정)
2. `cleanup_orphan_data.py` (새로 생성)

### 테스트 필요 사항

**발표 전 삭제 기능 테스트**:
1. 노트 생성
2. 노트 삭제 시도
3. 콘솔 로그 확인:
   ```
   📄 미디어 파일명: [파일명]
   [삭제 수행] meeting_dialogues: X개 삭제
   [삭제 수행] meeting_minutes: X개 삭제
   [삭제 수행] meeting_shares: X개 삭제
   [삭제 수행] Vector DB meeting_chunk: X개 삭제
   [삭제 수행] Vector DB meeting_subtopic: X개 삭제
   ✅ 미디어 파일 삭제 검증 성공
   ```

---

## 🎯 이번 수정으로 해결된 버그들

1. **meeting_shares 미삭제** (오늘 아침 수정) ✅
2. **Vector DB & 파일 고아 데이터** (방금 수정) ✅

---

## 🚀 다음 단계

### 발표 전 필수 확인
1. ✅ 문법 검증 완료
2. ⏳ 실제 삭제 기능 테스트 (직접 실행 필요)
3. ⏳ 고아 데이터 재발 여부 확인

### 추가 개선 (발표 후)
- 삭제 로직 트랜잭션 처리
- 삭제 실패 시 롤백 기능
- 주기적 고아 데이터 정리 스케줄러

---

## 📝 주요 교훈

### 문제의 본질
- 부분 삭제 실패로 인한 데이터 불일치
- 순환 참조 문제 (파일명 조회 → 삭제 → 조회 실패)

### 해결 방법
- 폴백 메커니즘 (SQLite → Vector DB)
- Graceful degradation (실패해도 계속 진행)
- 명확한 로깅

### 예방책
- 삭제 순서 고려
- 트랜잭션 처리
- 정기적인 데이터 정합성 검증

---

## ✅ 최종 상태

```
✅ 고아 데이터 정리 완료 (2개 meeting_id, 2개 파일)
✅ 삭제 로직 개선 완료
✅ 문법 검증 완료
⏳ 실제 실행 테스트 필요

준비 완료! 🎉
```
